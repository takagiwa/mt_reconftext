FPGA について
===============

.. note::

 この章では簡単化のために、アナログ信号を扱うデバイスについては省略します。

 また同じく簡単化のために、デバイスの一般名として IC、LSI は IC に統一します。

FPGA はディジタル信号を取り扱う IC の一種です。

IC は分類のひとつとして、書き換えられないもの、書き換えられるものに分けられます。

前者の例として特定用途向け集積回路（Application-specific integrated circuit = ASIC、Application-specific standard product = ASSP、この章では簡単化のために ASIC に統一）、
後者の例として FPGA があります。

ディジタル向けではできることはおおよそ同じです。

ASIC は一般に単価が安めに設定されるため、一般に量産品（家電量販店等で販売されているものや一般の乗用車等）向けに作られます。

製造に時間がかかり、製造コストが高額で、製造後の回路修正が一般に不可能なため、開発時の検証に多くの時間を費やすことから、開発コストも高額です。大量に使うことで、安価でも採算があうようにされています。

同様につくられた FPGA は、その中にユーザーが自由に回路を書き込み、さらに書き換えられるのが特徴です。

デバイスが入手できてしまえば、後からも回路修正が可能で、検証も（本来同様に時間をかけるべきですが）その分稀なパターンまでは想定しないなどで初期の開発時間、コストの軽減が可能です。価格決定権は ASIC に比べれば自由度が少ないため、最終製品も高額になりやすいです。

また FPGA はその自由度の代償として、デバイスに組み込める回路規模は ASIC より小さく、その割にデバイス全体規模が ASIC より大きく、消費電力を減らす自由度も少ないです。

一般向けの製品としては、価格、回路規模、消費電力から、使われることは稀です。

FPGA のポピュラーな用途は以下のようなものがあります。


IC の試作
--------------------------

ASIC と FPGA はできることはだいたい同じなので、FPGA でまず動作を検証し、その結果を ASIC の開発に反映する、ということがされます。

デバイス規模が不足するため、100万円を超える最大級のデバイスをさらに複数個並べて使います。


少量多品種の製品
----------------------------

IC の開発、製造にかかるコストの総額が、ターゲットの製品の出荷量や価格に見合わない場合は、そのまま FPGA を使います。

工場、研究所での計測、制御系（例：高速なセンサーの信号を取り込むボード、新開発のエンジンを制御するボード）では多く使われています。

また最近は比較的大量に販売される製品でも FPGA の採用が増えてきているようです（日本の一般自動車のオプションに組み込まれた例、欧州の一般自動車数万台に組み込まれた例や、携帯電話の基地局に使われる例など）。


ハイパフォーマンスコンピューティング（HPC）
--------------------------------------------------------------------------------

スーパーコンピュータのような、大量のデータを高速に演算するジャンルです。

スーパーコンピュータは様々な問題に対応できるよう汎用的な計算に対応するように作られています。

その中心は、結局は AND、OR、NOT、フリップフロップでできていますので、同じ事は FPGA でもできますが、瞬間的な速度は敵いません。

ただ特定の演算手順を回路として組み込んでしまえば、高速な CPU よりもさらに高速な演算も可能です。ゲノム解析で 10倍以上の高速化を達成したという例があります。

また CPU や GPGPU に比べて余計な回路が減るため、消費電力も削減されます。

ただし周囲のシステム構成が適切でないと速度がでないため、ハードルは高いです。

デジタルアニーラ、CMOSアニーラ、シミュレーテッド分岐マシンなどの量子インスパイアなコンピュータは一部 FPGA で処理を行っていました。

理化学研究所の量子コンピュータは、信号処理自身は量子ビットで行うものの、その制御には CPU や GPGPU では処理しきれない高速な信号処理が多くあるため、FPGA が使われています。


株・為替自動取引
------------------------------

コンピュータによる高頻度取引では1秒以下（一説にはミリ秒単位やそれ以下とも）の周期で株価、為替の情報を監視し、自身に有利なタイミングで売買を行います（簡単な例では、1ドル=99円の時にドルを買い、1ドル=100円の時にドルを売れば1円/ドルの益）。

ソフトウェアだけでの処理は遅いと考えられており、FPGA による処理が併用されます。


.. note::

 プログラミング可能なデバイスは様々な名前で作られています。細かい機能、性能、規模、価格に違いがあります。

 - FPGA (Filed Programmable Gate Array) = 高機能、高性能、大規模、高額
 - PLD (Programmable Logic Device) & CPLD (Complex PLD) = 中機能、中性能、中規模、中価格
 - PLA (Programmable Logic Array), PAL (Programmable Array Logic), GAL (Generic/Gate Array Logic) = 低機能、低性能、小規模、安価
 - GreenPAK = アナログに対応した小規模なデバイス


HDL
---------

ディジタル回路を組み込んだ IC や LSI の開発では、初期には AND 、OR 、NOT 、フリップフロップを CAD 上で回路図のように配置して接続していました。

こういった CAD は、IC 、LSI メーカ毎に異なるため、たとえば完成したデータを違う LSI メーカで製造しなければいけなくなったとき、互換性が無いため入力＆確認し直しが必要になっていました。

こういった状況を避けるために、IC 、LSI の開発も、ソフトウェアのようにテキストで行おうという動きがでてきました。このジャンルの言語は HDL  (Hardware Description Language) と呼ばれます。

ソフトウェアと同様、HDL も様々なものが開発されましたが、現在の主流は VerilogHDL と VHDL です。

VerilogHDL、VHDL は元々 IC、LSI の開発向けにつくられたもので、現在はほぼ全ての FPGA 開発環境で使えます。


VerilogHDL と VHDL
-----------------------

各言語の特徴を以下に示します (筆者の独断と偏見を含む) 

VerilogHDL

- 民間主導- ツールメーカが開発した。
- 比較的便利な記述ができるようになっている。
- 文法上記述ミスが許容される傾向がある＝ デバッグ時に大変なことが多い。適切な設定で回避可能。
- 日本でのシェアは、こちらがかすかに多いかもしれない。
- C 言語に近い、と評されることがあるものの、上記のような動きがあることから、むしろ BASIC の方が近いと感じる。
- 無料のシミュレータがあるため、特に趣味の範囲での人気は VHDL より高い模様。
- 後継として SystemVerilog という言語がある。

VHDL

- 米国国防省主導- ソフトウェアのプログラミング言語をベースに策定
- 融通が利かず、あまり高機能でない。コード量は多くなる傾向かもしれない。
- 海外でのシェアは、こちらがかすかに多いかもしれない。
- BASIC ににたキーワードもあるものの、文法エラーの検出の強さは C 言語に近い。


高位合成
-------------

HDL は一般にクロックや信号の衝突などソフトウェアとは異なる考え方が必要になります。それだけ、HDL のプログラマはソフトウェアのプログラマに比べ人口が少ないです。

それでも FPGA に魅力を感じている人々が長年ツールを開発し続け、2014年頃からそれが安価に入手できるようになりました。

AMD 社 ( Xilinx 社を買収 ) は HLS という名前で、C 言語での FPGA 開発ができるようになっています。

Intel 社 ( Altera 社を買収 )、Xilinx 社 [#f1]_ とも OpenCL 対応のデータ処理向けの開発環境をそろえています。

より高レベル (ハードウェアから遠いという意味で) な言語によるアプローチもあり、これらは高位合成と呼ばれています。

現在は Java 、Python などの言語での FPGA 開発が可能になっています。

ただし FPGA に組み込む回路全てをこれらの言語だけで開発できないパターンもあり、そういった箇所には引き続き VerilogHDL、VHDL が使われます。

.. rubric:: Footnotes

.. [#f1] FPGA メーカーは現在はあまり多くなく、Intel 社と AMD 社でほぼ寡占、Lattice 社が単独3位のようなポジションで、あとは小規模なメーカーがいくつか。

